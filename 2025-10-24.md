# Day 12: Network ACLs & Stateless Security

**Date:** October 24, 2025 (3-Year Amazon Anniversary!)  
**Focus:** Understanding stateless firewalls and subnet-level security  
**Time Investment:** ~2 hours

---

## What I Learned

Explored Network ACLs (NACLs) - the stateless, subnet-level firewall that works alongside Security Groups. Learned the critical difference between stateful and stateless security through hands-on experimentation.

**Key Concepts:**
- Default vs Custom NACLs
- Stateless firewall behavior
- Ephemeral ports and why they matter
- Defense in depth (layered security)
- Rule evaluation order

---

## Hands-On Experiments

### Experiment 1: Default NACL Analysis
Examined my default NACL protecting 3 subnets:
- **Inbound:** Rule 100 allows ALL traffic, Rule * denies all
- **Outbound:** Rule 100 allows ALL traffic, Rule * denies all
- **Behavior:** Permissive by default, relies on Security Groups for filtering

### Experiment 2: Custom NACL Creation
Created `chris-restrictive-nacl` to test stateless behavior:
- **Default state:** DENIES all inbound and outbound (deny-by-default)
- **Added inbound rule:** SSH (port 22) from 0.0.0.0/0 - ALLOW
- **Outbound rules:** Left as DENY ALL

### Experiment 3: SSH Connection Failure
Associated custom NACL with EC2 subnet and attempted SSH:
```bash
ssh -i ~/.ssh/chris-aws-key.pem ec2-user@18.221.221.87
# Result: Connection timed out
```

**Why it failed:**
- ‚úÖ Inbound SSH on port 22: NACL allowed, Security Group allowed
- ‚ùå Outbound response traffic: NACL blocked (no outbound rule)
- **Root cause:** NACL is stateless - doesn't remember inbound connection, blocks return traffic

### Experiment 4: Revert to Default
Reassociated subnet with default NACL:
- SSH immediately worked again
- Proved that NACL was the blocking layer, not Security Group

---

## Network Traffic Flow (What I Proved Today)
```
Internet ‚Üí Internet Gateway ‚Üí NACL (inbound) ‚Üí Security Group (inbound) ‚Üí EC2 Instance
                                      ‚Üì                                        ‚Üì
                               Checks every packet                    Remembers connection state
                                      ‚Üì                                        ‚Üì
Internet ‚Üê Internet Gateway ‚Üê NACL (outbound) ‚Üê Security Group (auto-allows) ‚Üê EC2 Response
```

---

## Key Insights

### 1. Stateful vs Stateless

**Security Groups (Stateful):**
- Remember connection state
- If inbound SSH allowed, return traffic auto-allowed
- No need for explicit outbound rules for responses
- Easier to manage

**Network ACLs (Stateless):**
- Don't remember connections
- Must explicitly allow BOTH inbound request AND outbound response
- Every packet evaluated independently
- More complex but more granular control

**Analogy:** 
- SG = Bouncer who remembers you entered, lets you leave automatically
- NACL = Security checkpoint that checks ID both entering AND exiting

### 2. Ephemeral Ports (Critical Networking Concept)

**What they are:** Temporary ports (1024-65535) used by clients to receive responses

**How they work:**
```
Client laptop connects to web server:
- Source: ClientIP:54321 (ephemeral) ‚Üí Destination: ServerIP:443 (HTTPS)

Server responds:
- Source: ServerIP:443 ‚Üí Destination: ClientIP:54321 (ephemeral)
```

**Why NACLs need them:**
- NACL outbound rules must allow traffic TO ephemeral ports (1024-65535)
- Without this, responses can't reach clients
- Security Groups don't need this (stateful auto-allows)

**Real example from today:**
- My SSH client used random ephemeral port (e.g., 54789) to receive responses
- EC2 responded FROM port 22 TO my port 54789
- Custom NACL blocked outbound to 54789 ‚Üí connection failed

### 3. Default vs Custom NACLs

**Default NACL:**
- Created with every VPC
- Allows ALL inbound and outbound by default
- Permissive starting point

**Custom NACL:**
- Created manually
- DENIES all inbound and outbound by default
- Restrictive starting point (must add explicit allows)

### 4. Defense in Depth

**Production pattern:**
- **NACLs:** Broad subnet-level blocking (block malicious IP ranges, DDoS protection)
- **Security Groups:** Granular instance-level control (application-specific rules)

**Example architecture:**
- Public subnet NACL: Block known bad IPs, allow 80/443
- Web server SG: Allow 80/443 from anywhere, SSH from office IP only
- Private subnet NACL: Block all except from public subnet
- Database SG: Allow 3306 only from web server SG

**Why both?** Multiple layers mean if one fails, the other catches threats.

---

## Rule Evaluation Order

**AWS checks security in this order:**

1. **NACL Inbound** ‚Üí Does subnet-level NACL allow this traffic?
2. **Security Group Inbound** ‚Üí Does instance-level SG allow this traffic?
3. **EC2 Instance** ‚Üí Traffic reaches instance
4. **Security Group Outbound** ‚Üí Auto-allowed (stateful), or check if instance initiates new connection
5. **NACL Outbound** ‚Üí Does subnet-level NACL allow response traffic?

**If NACL blocks at step 1, AWS never checks Security Group.**

---

## Security Group vs NACL Comparison

| Feature | Security Group | Network ACL |
|---------|---------------|-------------|
| **Level** | Instance | Subnet |
| **State** | Stateful (remembers connections) | Stateless (every packet evaluated) |
| **Rules** | Allow only (deny-by-default) | Allow AND Deny rules |
| **Return Traffic** | Auto-allowed | Must explicitly allow |
| **Evaluation** | All rules evaluated | Rules evaluated in number order (100, 110, *) |
| **Default Behavior** | Deny all inbound, allow all outbound | Depends: Default NACL allows all, Custom NACL denies all |
| **Use Case** | Application-specific security | Subnet-level defense, block IP ranges |

---

## Production Best Practices

1. **Use Security Groups as primary security:** Easier to manage, stateful behavior
2. **Use NACLs for subnet-level defense:** Block bad IPs, compliance requirements
3. **Custom NACLs require ephemeral ports:** Always allow 1024-65535 for return traffic
4. **Test changes carefully:** NACL mistakes can break all instances in a subnet
5. **Rule numbering:** Use increments of 10 (100, 110, 120) to allow insertions later

---

## Interview-Ready Explanations

**Q: What's the difference between Security Groups and NACLs?**

A: "Security Groups are stateful, instance-level firewalls that remember connection state and auto-allow return traffic. Network ACLs are stateless, subnet-level firewalls that evaluate every packet independently and require explicit rules for both directions. In production, we use both for defense in depth - NACLs provide broad subnet protection against known threats, while Security Groups provide granular instance security."

**Q: Why do NACL outbound rules need ephemeral ports?**

A: "When clients connect to a server, they use temporary ephemeral ports (1024-65535) to receive responses. Since NACLs are stateless, they don't remember the original connection, so outbound rules must explicitly allow traffic to these ephemeral ports. Security Groups don't need this because they're stateful and auto-allow return traffic."

**Q: When would you use a Custom NACL in production?**

A: "Custom NACLs are useful for compliance requirements or blocking specific IP ranges at the subnet level. For example, if you're under DDoS attack from certain IPs, you can block them at the NACL level before they even reach your Security Groups. NACLs are also used in multi-tier architectures to enforce network segmentation - like ensuring private subnets can only communicate with specific public subnets."

---

## Challenges & Corrections

**Challenge:** Initially misunderstood that Security Groups could have DENY rules.

**Correction:** Security Groups are allow-only. They're deny-by-default, so you only add ALLOW rules. NACLs support both ALLOW and DENY.

**Challenge:** Thought I needed to add both inbound AND outbound rules to Security Groups for bidirectional traffic.

**Correction:** Security Groups are stateful. If you allow inbound, return traffic is auto-allowed. You only add outbound rules when your instance INITIATES connections (like connecting to a database or sending logs to CloudWatch).

**Challenge:** Didn't understand why ephemeral ports existed.

**Correction:** Clients need their own listening ports to receive responses. Port 443 is the server's listening port, not the client's. The client picks a random ephemeral port (like 54321) to receive the response. This is fundamental TCP/IP networking.

---

## What I Built

- Created custom NACL (`chris-restrictive-nacl`)
- Tested stateless behavior by breaking SSH
- Proved layered security model
- Documented comparison table for future reference

---

## Next Steps

- Day 13: VPC Endpoints (private AWS service access without IGW)
- Day 14: Week 2 review and portfolio planning
- Day 15: Start Week 3 - boto3 and Python automation

---

**Streak Status:** Day 12 of 90 (13.3% complete) üî•

**Key Takeaway:** Stateless vs stateful is the foundation of network security. NACLs add subnet-level defense, but Security Groups are easier to manage for most use cases. Production architectures use both for defense in depth.
