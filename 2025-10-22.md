# Day 10: IAM Roles - Removing Hardcoded Credentials

**Date:** October 22, 2025  
**Focus:** Production-grade security with IAM Roles instead of access keys  
**Time Investment:** 85 minutes

---

## What I Built

Replaced hardcoded AWS access keys with an IAM Role attached to my EC2 instance. Removed plaintext credentials from the instance and verified AWS CLI still functions using temporary, auto-rotating credentials from STS.

**Technical Changes:**
- Created IAM Role: chris-ec2-s3-role (AmazonS3FullAccess policy)
- Attached role to EC2 instance
- Removed ~/.aws/credentials file
- Verified AWS CLI uses IAM Role for authentication

---

## Commands Executed

### IAM Role Verification
```bash
# Test AWS CLI still works (using role, not keys)
aws s3 ls
aws s3 ls s3://chris-aws-journey-2025/

# Check authentication source
aws configure list

# View temporary credentials from EC2 metadata service (IMDSv2)
TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")
curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/iam/security-credentials/chris-ec2-s3-role
```

### Removing Hardcoded Credentials
```bash
# Remove access keys from instance
rm ~/.aws/credentials

# Verify AWS CLI STILL works
aws s3 ls
```

---

## Key Learnings

**IAM Users vs IAM Roles:**
- IAM Users: Identity-based entities with long-lived credentials (access keys, passwords)
- IAM Roles: Temporary credentials assumed by services for specific purposes
- Use users for human access, roles for programmatic/service access

**How IAM Roles Work:**
1. EC2 instance assumes the role (chris-ec2-s3-role)
2. AWS Security Token Service (STS) generates temporary credentials
3. EC2 metadata service delivers credentials to the instance
4. AWS CLI automatically retrieves and uses them
5. Credentials expire (typically 1-6 hours) and AWS auto-rotates them

**Security Improvements:**
- No plaintext access keys stored on disk
- Credentials expire automatically and can't be reused elsewhere
- Even if instance is compromised, stolen credentials are temporary
- Credentials include session tokens (not just access key + secret)

**EC2 Metadata Service (IMDSv2):**
Discovered that newer EC2 instances use IMDSv2, which requires token-based authentication to access metadata. This prevents SSRF (Server-Side Request Forgery) attacks. The metadata endpoint (169.254.169.254) is a link-local address only accessible from within the instance - it's not routable from the internet.

**IAM User Cleanup:**
The chris-cli-user IAM user created on Day 9 is no longer needed. Deleted it to reduce attack surface and maintain good security hygiene. Access keys that existed with that user are now permanently removed.

---

## Knowledge Check Answers

**Q: Difference between IAM User and IAM Role?**  
IAM Users are identity-based entities with long-lived credentials, typically used for human access or specific applications. IAM Roles provide temporary credentials that services assume for specific purposes. Users have permanent access keys; roles use auto-rotating STS credentials. Use users when you need persistent identity, roles when services need to access other services.

**Q: How does EC2 get credentials without the credentials file?**  
The EC2 instance assumes the IAM role, and AWS Security Token Service (STS) generates temporary credentials. These are delivered via the EC2 metadata service endpoint (169.254.169.254). The AWS CLI automatically retrieves them from this endpoint when running commands. No hardcoded credentials needed.

**Q: How long are role credentials valid?**  
IAM role credentials typically expire every 1-6 hours (AWS determines the duration). AWS automatically rotates them before expiration. The application never needs to handle rotation - it's completely transparent. Each credential set includes an expiration timestamp.

**Q: Security difference between keys and roles?**  
With hardcoded access keys, an attacker who compromises the instance can copy the keys and use them indefinitely from anywhere. With IAM roles, the attacker only gets temporary credentials tied to that specific instance. These credentials expire within hours and include session tokens that make them harder to reuse. Role-based credentials can't be extracted and used elsewhere.

**Q: Why can't external users access the metadata endpoint?**  
169.254.169.254 is a link-local IP address, only routable within the EC2 instance itself - similar to localhost (127.0.0.1). It's not accessible over the internet or even from other EC2 instances. IMDSv2 adds an additional security layer requiring token-based authentication, preventing SSRF attacks.

**Q: Should I delete the IAM user?**  
Yes. The chris-cli-user IAM user serves no purpose now that the EC2 instance uses a role. Deleting it reduces the attack surface and follows AWS security best practices. Fewer unused credentials = lower risk of compromise.

---

## Challenges Encountered

**Challenge: IMDSv2 Token Requirement**  
Simple curl commands to the metadata endpoint returned no data. Discovered the instance uses IMDSv2 (Instance Metadata Service v2), which requires token-based authentication.

**Solution:** Generated a session token first using PUT request, then passed it in the header for all metadata requests. This is a more secure default that AWS now uses for new instances.

---

## Next Steps

- Day 11: VPC networking fundamentals (understand how EC2 connects to internet)
- Practice: Explore other AWS services that use IAM Roles (Lambda, ECS, etc.)
- Security: Enable MFA on AWS root account if not already done

---

## Week 2 Progress

- Day 8: ✅ EC2 instance + web server
- Day 9: ✅ AWS CLI + S3 integration  
- Day 10: ✅ IAM Roles (production security)
- Day 11-14: VPC networking, security groups, week review
